<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Волновое сопротивление</title>
    <link rel="icon" href="/img/icon.png" type="image/png">
    <link href="css/font.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script type="text/javascript" src="eel.js"></script>
    <script type="text/javascript" src="js/jquery-3.5.1.min.js"></script>
    <script type="text/javascript" src="js/chart.min.js"></script>
    <script type="text/javascript" src="js/plugin-select.js"></script>
    <script type="text/javascript" src="js/peak-values-plugin.js"></script>

    <script>
        var ctx
        var myChart
        var $state_btn
        var $cur_value
        $(document).ready(function () {
            $state_btn = $('#state-btn')
            $cur_value = $('#cur-value')
            $('#multiply').change(function () {
                eel.set_multiply($(this).val())
            })
            $('#start_zero').change(function () {
                eel.start_from_zero(this.checked)
            })
            ctx = document.getElementById('myChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'line',
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1.2,
                data: {
                    labels: [],
                    datasets: [{
                        label: "Нагрузка",
                        data: [],
                        fill: false,
                        borderColor: '#096ac9',
                    }]
                },
                options: {
                    legend: {
                        display: false,
                        position: 'top',
                        labels: {
                            boxWidth: 80,
                            fontColor: 'black'
                        }
                    },
                    layout: {
                        padding: {
                            top: 15,
                            bottom: 15,
                        }
                    },
                    scales: {
                        xAxes: [{
                            ticks: {
                                // Include a dollar sign in the ticks
                                callback: function (value, index, values) {
                                    return value + 'c';
                                }
                            }
                        }],
                        yAxes: [{
                            ticks: {
                                // Include a dollar sign in the ticks
                                callback: function (value, index, values) {
                                    return value + ' кг';
                                }
                            }
                        }]
                    },
                    tooltips: {
                        enabled: true,
                        mode: 'single',
                        callbacks: {
                            label: function (tooltipItems, data) {
                                return tooltipItems.yLabel + ' кг';
                            }
                        }
                    },
                    // events: ['mousedown', 'mouseup', 'mousemove'],
                    // select: {
                    //     selectCallback: (startPoint, endPoint) => {
                    //         console.log(startPoint, endPoint)
                    //     }
                    // },
                    hover: {
                        animationDuration: 0,
                    },
                    animation: {
                        duration: 500,
                    },

                    plugins: {
                        peakValuesPlugin: {
                            minimumDifference: 0.1,
                            color: 'black',
                            fontSize: '0.7em',
                            distance: 15,
                        },
                    }
                }
            });
        })

        $(window).resize(function () {
            //myChart.canvas.parentNode.style.height = ($(window).height()-150) + 'px';
        });


        eel.expose(addData)

        var state = 'stop'

        function addData(label, data) {
            myChart.data.labels.push(parseFloat(label.replace('s', '')));
            myChart.data.datasets[0].data.push(parseFloat(data));

            $cur_value.text(data)
        }

        eel.expose(updateChart)

        function updateChart(duration) {
            myChart.update(duration);
        }

        function clickStartStop() {
            if (state === 'stop') {
                eel.start()
                state = 'start'
                $state_btn.text('Стоп')
                $('#chart-name-row').addClass('hide')
            } else {
                eel.stop()
                state = 'stop'
                $state_btn.text('Старт')
            }
        }

        eel.expose(cl)

        function cl() {
            myChart.data.labels = []
            myChart.data.datasets[0].data = []
            myChart.update();
            $cur_value.text('None')
            $('#m_offset').text('None')
            eel.clear()
            $('#chart-name-row').addClass('hide')
        }

        eel.expose(chart_opened)

        function chart_opened(name) {
            $('#chart-name-row').removeClass('hide')
            $('#chart-name').text(name)
        }

        function save_chart() {
            var template = $('#template').val()
            eel.save_chart(template)
            if (myChart.data.labels.length === 0) {
                alert("График пуст")
            }
        }

        eel.expose(set_chart_template)

        function set_chart_template(template) {
            $('#template').val(template)
        }

        eel.expose(error)

        function error(msg) {
            $cur_value.text(msg)
        }

        eel.expose(set_multiply)

        function set_multiply(mult) {
            $('#multiply').val(mult)
        }

        eel.expose(set_start_zero)

        function set_start_zero(value) {
            $('#start_zero').prop('checked', value)
        }

        eel.expose(set_moffset)

        function set_moffset(m_offset) {
            $('#m_offset').text(m_offset)
        }
    </script>
</head>
<body style="min-width: 400px">
<canvas id="myChart" style="width: 100%; height: calc(100vh - 170px)"></canvas>
<div id="chart-name-row" class="row hide cfont">
    <span>График: </span><span id="chart-name"></span>
</div>
<div class="row">
    <a id="state-btn" class="btn left cfont" onclick="clickStartStop()">
        Старт
    </a>
    <div class="cur-value cfont">
        <span>Текущее значение:</span>
        <span id="cur-value">None</span>
    </div>
    <a id="reset-btn" class="btn right cfont" onclick="cl()">
        Очистить
    </a>
</div>
<div class="row">
    <a id="save-btn" class="btn left cfont" onclick="save_chart()">Сохранить</a>
    <a id="open-btn" class="btn left cfont" onclick="eel.open_chart()">Открыть</a>
    <label for="template" class="cfont">Шаблон названия</label>
    <input id="template" type="text">
</div>
<div class="row">
    <label for="multiply" class="cfont">Множитель</label>
    <input id="multiply" type="text">
    <div class="col">
        <label for="start_zero" class="cfont">Обнулять старт</label>
        <input id="start_zero" type="checkbox">
    </div>
    <div class="col cfont">
        <span>Натяжение троса: </span>
        <span id="m_offset">None</span>
    </div>
</div>
</body>
</html>